{% extends "base.html" %}
{% load i18n %}
{% load tz %}
{% block external %}
	<script type="text/javascript" src="{{ STATIC_URL }}chasebot/chasebot_add_deals.js"></script>
{% endblock %}
{% block title %}{{ template_title }}{% endblock %}
{% block head %}{{ template_title }}{% endblock %}
{% block content %}
<form method="post" action=".">
    {% csrf_token %}		
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
		    	<div class="span6">
		        <table class="table edit_table">
		            <tbody>
		                <tr>
		                    <td>                        
		                        {{form.conversation_date.label}}: {% if  form.conversation_date.field.required %} *{% endif %}
		                    </td>
		                    <td>                        
		                        {% if form.conversation_date.errors %}
			                	<div class="field field_error">
			                    	{{form.conversation_date}} {{form.conversation_date.errors}}                   	
			                	</div>
			                	{% else %}
			                		{{form.conversation_date}}
			                	{% endif %}   
			                	{% get_current_timezone as TIME_ZONE %}{{TIME_ZONE}}                     
		                    </td>
		                </tr>    
		                <tr>
		                    <td>                        
		                        {{form.conversation_time.label}}: {% if  form.conversation_time.field.required %} *{% endif %}
		                    </td>
		                    <td>                        
		                        {% if form.conversation_time.errors %}
			                	<div class="field field_error">
			                    	{{form.conversation_time}} {{form.conversation_time.errors}}                   	
			                	</div>
			                	{% else %}
			                		{{form.conversation_time}}
			                	{% endif %}                        
		                    </td>
		                </tr>            
		                <tr>
		                    <td>                        
		                        {{form.subject.label}}: {% if  form.subject.field.required %} *{% endif %}
		                    </td>
		                    <td>                        
		                        {% if form.subject.errors %}
			                	<div class="field field_error">
			                    	{{form.subject}} {{form.subject.errors}}                   	
			                	</div>
			                	{% else %}
			                		{{form.subject}}
			                	{% endif %}                        
		                    </td>
		                </tr>            
		                <tr>
		                    <td>                        
		                        {{form.notes.label}}: {% if  form.notes.field.required %} *{% endif %}
		                    </td>
		                    <td>                        
		                        {% if form.notes.errors %}
			                	<div class="field field_error">
			                    	{{form.notes}} {{form.notes.errors}}                   	
			                	</div>
			                	{% else %}
			                		{{form.notes}}
			                	{% endif %}                        
		                    </td>
		                </tr>
		                <tr>
		                	{{ opendeal_formset.management_form }}
		                	<table class="table edit_table">
		                		<thead>
		                			<tr>
		                				{% if opendeal_formset.forms %}	 <td>{% trans 'Is the conversation about this deal?' %}</td>{%endif%}
					                	<td class="bold_cb">				                		
			        						{% trans 'Open Deals in Progress:'%}		
				        				</td>
					                </tr>
		                		</thead>
		                		<tbody>				                
	                			{% if opendeal_formset.forms %}	                			
					                {% for fs in opendeal_formset %}  
					                	{{ fs.id }} 
					            	<tr>
					            		<td>
					            			{{fs.attach_deal_conversation}}
					            		</td>            		
					                    <td>										
											<input type="hidden" name="hidden-{{ fs.prefix }}-deal_template" value="{{fs.deal_template.value}}" />										
											{% if opendeal_formset.non_form_errors %}
						                	<div class="field field_error">
						                    	{{fs.deal_instance_name}}                    	
						                	</div>
						                	{% else %}
						                		{{fs.deal_instance_name}}					                		
						                	{% endif %}
					                    </td>
					                    <td>                        
					                        {% if fs.status.errors %}
						                	<div class="field field_error">
						                    	{{fs.status}} {{fs.status.errors}}                   	
						                	</div>
						                	{% else %}
						                		{{fs.status}}					                		
						                	{% endif %}                        
					                    </td>
					            	</tr>            	
				            		{% endfor %}
				            		{% if opendeal_formset.non_form_errors %}
			            			<tr>
			            				<td>
			            					<div class="field field_error">
			            						{{opendeal_formset.non_form_errors}}
			            					</div>
			            				</td>
			            			</tr>	
				            		{% endif %}
			            		{% elif is_atleast_one_opendeal_attached %}
				            		<tr>
	                					<td>
											{% trans 'All open deals are already attached to this conversation.' %}                						
	                					</td>
	                				</tr>
	            				{% else %}
	            					<tr>
	                					<td>
											{% trans 'No new deals are negotiated yet with this client.' %}                						
	                					</td>
	                				</tr>  
			            		{% endif %}
		                		</tbody>
		                	</table>
		                </tr>        	
		            </tbody>
		        </table>
		    </div>
		    	<div class="span6">
		    		<table id="right_side">
		    			<tbody>
		    				<tr>
			            		{% include '_deal_add_edit.html' %}			            		
			            	</tr>
		    				<tr>
			    				<!-- {{ attached_deals_formset.management_form }}	       -->          	
				            	<table class="table edit_table">
				            		<thead>
				            			<tr>	                				
						                	<td class="bold_cb">				                		
				        						{% trans 'Deals attached to this Conversation:' %}			
					        				</td>
						                </tr>
				            		</thead>
				            		<tbody>				                
									<!-- {% if attached_deals_formset.forms %}
						                {% for fs in attached_deals_formset %}  
						                	{{ fs.id }} 
						            	<tr>
						            		            		
						                    <td>										
												<input type="hidden" name="hidden-{{ fs.prefix }}-deal_template" value="{{fs.deal_template.value}}" />										
												{% if attached_deals_formset.non_form_errors %}
							                	<div class="field field_error">
							                    	{{fs.deal_instance_name}}                    	
							                	</div>
							                	{% else %}
							                		{{fs.deal_instance_name}}					                		
							                	{% endif %}
						                    </td>
						                    <td>                        
						                        {% if fs.status.errors %}
							                	<div class="field field_error">
							                    	{{fs.status}} {{fs.status.errors}}                   	
							                	</div>
							                	{% else %}
							                		{{fs.status}}					                		
							                	{% endif %}                        
						                    </td>
						            	</tr>            	
					            		{% endfor %}
					            		{% if attached_deals_formset.non_form_errors %}
				            			<tr>
				            				<td>
				            					<div class="field field_error">
				            						{{attached_deals_formset.non_form_errors}}
				            					</div>
				            				</td>
				            			</tr>	
					            		{% endif %}
				            		{% else %}
					            		<tr>
				        					<td>
												{% trans 'No deals attached yet to this conversation' %}                						
				        					</td>
				        				</tr>  
				            		{% endif %} -->
				            		</tbody>
				            	</table>
			            	</tr>
			            	
		    			</tbody>
		    		</table>	        
		    	</div>    
			</div>
		</div>
	</div>

    <p>
        <input type="submit" value="{% trans 'Save' %}" class="btn btn-primary" />
        <input name="cancel" type="button" value="{% trans 'Cancel' %}" class="btn" onclick="history.go(-1)"/>
    </p>
</form>
{% endblock %}